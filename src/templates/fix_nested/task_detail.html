{% extends "base.html" %}

{% block title %}Task {{ task.id[:8] }} - Fix Nested{% endblock %}

{% block content %}
<div class="container">
    <div class="mb-3">
        <a href="{{ url_for('fix_nested_explorer.list_tasks') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to Tasks
        </a>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header">
            <h3 class="mb-0">
                <i class="bi bi-info-circle"></i> Task Details
            </h3>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <dl class="row">
                        <!-- <dt class="col-sm-4">Task ID:</dt>
                        <dd class="col-sm-8"><code>{{ task.id }}</code></dd> -->

                        <dt class="col-sm-4">Filename:</dt>
                        <dd class="col-sm-8">
                            <!-- {{ file_name_to_link }} -->
                            {% if file_name_to_link %}
                            <a href='https://commons.wikimedia.org/wiki/File:{{ file_name_to_link }}' target='_blank'
                                rel='noopener noreferrer'>
                                File:{{ file_name_to_link }}
                            </a>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-4">Status:</dt>
                        <dd class="col-sm-8">
                            {% set status_class = {
                                'pending': 'secondary',
                                'running': 'primary',
                                'completed': 'success',
                                'failed': 'danger',
                                'upload_failed': 'warning',
                                'undone': 'info'
                            }.get(task.status, 'secondary') %}
                            <span class="badge bg-{{ status_class }}">{{ task.status }}</span>
                        </dd>

                        <dt class="col-sm-4">Username:</dt>
                        <dd class="col-sm-8">{{ task.username or '-' }}</dd>
                        <dt class="col-sm-4">Download result:</dt>
                        <dd class="col-sm-8">{{ task.download_result.status or task.download_result.error or '-' }}</dd>
                        <dt class="col-sm-4">Upload result:</dt>
                        <dd class="col-sm-8">{{ task.upload_result.status or task.upload_result.error or '-' }}</dd>
                    </dl>
                </div>
                <div class="col-md-6">
                    <dl class="row">
                        <dt class="col-sm-5">Tags Before:</dt>
                        <dd class="col-sm-7">
                            {{ task.nested_tags_before if task.nested_tags_before is not none else '-' }}</dd>

                        <dt class="col-sm-5">Tags After:</dt>
                        <dd class="col-sm-7">{{ task.nested_tags_after if task.nested_tags_after is not none else '-' }}
                        </dd>

                        <dt class="col-sm-5">Tags Fixed:</dt>
                        <dd class="col-sm-7">
                            {% if task.nested_tags_fixed is not none %}
                            <span class="badge bg-success">{{ task.nested_tags_fixed }}</span>
                            {% else %}
                            -
                            {% endif %}
                        </dd>

                        <dt class="col-sm-5">Created:</dt>
                        <dd class="col-sm-7">
                            {{ task.created_at.strftime('%Y-%m-%d %H:%M:%S') if task.created_at else '-' }}</dd>

                        <dt class="col-sm-5">Updated:</dt>
                        <dd class="col-sm-7">
                            {{ task.updated_at.strftime('%Y-%m-%d %H:%M:%S') if task.updated_at else '-' }}</dd>
                    </dl>
                </div>
            </div>

            {% if task.error_message %}
            <div class="alert alert-danger mt-3">
                <strong>Error:</strong> {{ task.error_message }}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Files Section -->
    <div class="card shadow mb-4">
        <div class="card-header">
            <h4 class="mb-0">
                <i class="bi bi-files"></i> Files
            </h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h5>Original File</h5>
                    {% if has_original %}
                    <a href="{{ url_for('fix_nested_explorer.serve_file', task_id=task.id, file_type='original') }}"
                        class="btn btn-primary mb-2" target="_blank">
                        <i class="bi bi-download"></i> Download Original
                    </a>
                    {% else %}
                    <p class="text-muted">Not available</p>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    <h5>Fixed File</h5>
                    {% if has_fixed %}
                    <a href="{{ url_for('fix_nested_explorer.serve_file', task_id=task.id, file_type='fixed') }}"
                        class="btn btn-success mb-2" target="_blank">
                        <i class="bi bi-download"></i> Download Fixed
                    </a>
                    {% else %}
                    <p class="text-muted">Not available</p>
                    {% endif %}
                </div>
            </div>

            {% if has_original and has_fixed %}
            <div class="mt-3">
                <a href="{{ url_for('fix_nested_explorer.compare', task_id=task.id) }}" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left-right"></i> Compare Files
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Results Section -->

    <!-- Metadata Section -->
    {% if metadata and is_admin %}
    <div class="card shadow mb-4">
        <div class="card-header">
            <h4 class="mb-0">
                <i class="bi bi-file-earmark-code"></i> Metadata
            </h4>
        </div>
        <div class="card-body">
            <pre class="bg-light p-3 rounded"><code>{{ metadata | tojson(indent=2) }}</code></pre>
        </div>
    </div>
    {% endif %}

    <!-- Log Section -->
    {% if log_content and is_admin %}
    <div class="card shadow mb-4">
        <div class="card-header bg-warning text-dark">
            <h4 class="mb-0">
                <i class="bi bi-terminal"></i> Task Log
            </h4>
        </div>
        <div class="card-body">
            <pre class="bg-dark text-light p-3 rounded"
                style="max-height: 400px; overflow-y: auto;"><code>{{ log_content }}</code></pre>
            <a href="{{ url_for('fix_nested_explorer.view_log', task_id=task.id) }}"
                class="btn btn-sm btn-outline-secondary mt-2" target="_blank">
                <i class="bi bi-box-arrow-up-right"></i> Open in New Tab
            </a>
        </div>
    </div>
    {% endif %}

    <!-- Actions -->
    {% if task.status == 'completed' and task.upload_result == 'Success' %}
    <div class="card shadow mb-4">
        <div class="card-header bg-success text-white">
            <h4 class="mb-0">
                <i class="bi bi-gear"></i> Actions
            </h4>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('fix_nested_explorer.undo_task', task_id=task.id) }}"
                onsubmit="return confirm('Are you sure you want to undo this task and restore the original file? This will upload the original file back to Commons.');">
                <button type="submit" class="btn btn-warning">
                    <i class="bi bi-arrow-counterclockwise"></i> Undo & Restore Original
                </button>
            </form>
            <p class="text-muted mt-2 mb-0">
                <small>This will upload the original file back to Commons and mark this task as undone.</small>
            </p>
        </div>
    </div>
    {% endif %}

    {% if task.status == 'undone' %}
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> This task has been undone. The original file was restored to Commons.
    </div>
    {% endif %}
</div>
{% endblock %}
